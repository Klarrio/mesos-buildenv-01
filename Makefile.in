PREFIX=/usr/local
SRCDIR=$(srcdir)

.PHONY: all

all: $(PREFIX)/include/boost $(PREFIX)/include/google/protobuf $(PREFIX)/share/java/protobuf.jar $(PREFIX)/include/glog $(PREFIX)/include/picojson.h

boost_1_53_0.tar.gz:
	wget https://downloads.sourceforge.net/project/boost/boost/1.53.0/boost_1_53_0.tar.gz
protobuf-2.5.0.tar.gz:
	wget https://protobuf.googlecode.com/files/protobuf-2.5.0.tar.gz
glog-0.3.3.tar.gz:
	wget https://google-glog.googlecode.com/files/glog-0.3.3.tar.gz

picojson-25fc213.tar.gz:
	curl -L https://github.com/kazuho/picojson/tarball/25fc213 -o picojson-25fc213.tar.gz
# Use stamp files as dependencies so that the packages get extracted
# and patches applied as appropriate.
%-stamp: %.tar.gz
	tar -xf $^
	test ! -e $SRCDIR/patches/$*.patch || patch -d $* -p1 <$SRCDIR/patches/$*.patch
	touch $@

$(PREFIX)/include/boost: boost_1_53_0-stamp
	mkdir -p $(PREFIX)/include/
	cp -r boost_1_53_0/boost $(PREFIX)/include/
	rm -rf $(PREFIX)/include/boost/phoenix $(PREFIX)/include/boost/fusion $(PREFIX)/include/boost/spirit
	touch $@

$(PREFIX)/include/google/protobuf: protobuf-2.5.0-stamp
	cd protobuf-2.5.0 && ./configure --prefix=$(PREFIX) --disable-static
	$(MAKE) -C protobuf-2.5.0 install

$(PREFIX)/share/java/protobuf.jar: $(PREFIX)/include/google/protobuf protobuf-2.5.0-stamp $(PREFIX)/include/google/protobuf
	cd protobuf-2.5.0/java && mvn package
	mkdir -p `dirname $@`
	cp protobuf-2.5.0/java/target/protobuf-java-2.5.0.jar $@

$(PREFIX)/include/glog: glog-0.3.3-stamp
	cd glog-0.3.3 && ./configure --prefix=$(PREFIX) GTEST_CONFIG=no --disable-static
	$(MAKE) -C glog-0.3.3 install

$(PREFIX)/include/picojson.h: picojson-25fc213-stamp
	mkdir -p `dirname $@`
	cp kazuho-picojson-25fc213/picojson.h $(PREFIX)/include/picojson.h
